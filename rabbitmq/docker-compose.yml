x-default: &default
  networks:
    - traefik-net
  # cpus: 0.5
  # mem_limit: 500M
  restart: unless-stopped
  # init: true
  # privileged: true
  # stdin_open: true
  # tty: true
  logging:
    driver: "json-file"
    options:
      max-size: "10M"
      max-file: "3"

volumes:
  rabbitmq_data:

networks:
  traefik-net:
    external: true

services:
  rabbitmq:
    <<: *default
    image: rabbitmq:4.2.2-management-alpine
    container_name: rabbitmq
    # Fixed hostname is mandatory for RabbitMQ to maintain node identity and data persistence
    hostname: rabbitmq-node
    environment:
      # Initial credentials for the management UI and API
      - RABBITMQ_DEFAULT_USER=dev
      - RABBITMQ_DEFAULT_PASS=dev
      # Shared secret for clustering nodes (useful for future scaling)
      - RABBITMQ_ERLANG_COOKIE=secure_cluster_cookie_string
    ports:
      # Standard AMQP protocol port
      - "5672:5672"
      # Management UI and HTTP API
      - "15672:15672"
      # Prometheus metrics endpoint
      - "15692:15692"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    healthcheck:
      # Ensure the service is ready before other services connect
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.example.com`)"
      - "traefik.http.routers.rabbitmq.entrypoints=https"
      - "traefik.http.routers.rabbitmq.tls.certresolver=ssl"
      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"


